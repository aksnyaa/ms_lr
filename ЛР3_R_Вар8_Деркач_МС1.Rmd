---
title: "ЛР3_Вар8_ДеркачАксинья_МС1"
author: "Деркач Аксинья"
date: "2024-12-18"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Раздел 3. Дисперсионный анализ (Anova)

### 1.1. Однофакторный дисперсионный анализ (One-Way ANOVA)

#### 1.1.1. Основные понятия

Рассмотрим Дисперсионный анализ на примере результатов исследования объема выручки малых предприятий города (млн. руб.) в зависимости от двух факторов: времени реализации и соотношения заемных и собственных средств (из задачи 7.52 варианта 8 из ДКР3).

Прежде всего установим рабочую директорию и загрузим таблицу с данными, которые сейчас находятся в файле Excel, расположенном в папке с кодом.

```{r}
library(readxl) 
data = read_excel('752.xlsx')
```

Проверим, что в себе содержит файл.

```{r}
data
```

Имеем 12 наблюдений, 3 столбца. Первый столбец соответствует соотношению заемных и собственных средств (Ratio), второй столбец - период реализации, номер квартала (Date), третий столбец - выручка фирм (Revenue).

Начнем с расчета средних значений по каждому показателю. Для этого используем функцию tapply, принимающую на вход 3 аргумента: выручка (для которой мы хотим посчитать среднее 
значения), соотношение/период (по которым мы группируем эти величины) и операция взятия среднего (то, что мы хотим получить).  Тем самым мы получим среднее значение выручки малых предприятий.
Сформируем этот новый объект и посмотрим, что получилось.

```{r}
meanRat = tapply(data$Revenue, data$Ratio, mean)
meanRat
```

Мы получили три значения: 99, 101, 98.5, соответственно. Это средние значения выручки в зависимоти от соотношения заемных и собственных средств. Аналогично, сделаем для периода реализации (по кварталам).

```{r}
meanD = tapply(data$Revenue, data$Date, mean)
meanD
```

Средние размеры выручки по кварталам: 99, 100, 96, 103.

#### 1.1.2. Графическое представление различий между средними изучаемых групп

Рассмотрим различные способы визуализации различий между уровнями изучаемого фактора. 
Далее построим два графика, которые сгруппируют значения выручки по соответствующим уровням факторов, отдельно для периода реализации и отдельно для соотношения средств. Первая группировка у нас будет идти по периодам. Посмотрим, что даст соответствующая операция 
stripchart.

```{r , fig.cap='Рис. 1. Точечный график зависимости выручки малых предприятий от периода реализации с помощью функции stripchart'}
stripchart(Revenue ~ Date, data = data, col = '#96f364', ylab = 'Date',
xlab = 'Revenue', main = 'Date')
```

На графике (рис. 1) по оси X откладываются величины выручки, по оси Y — уровни фактора, от первого до четвертого. В результате снизу вверх видим выручку для компаний в 1 квартале, 2, 3 и 4. 

Аналогично сделаем для соотношения заемных и собственных средств.

```{r , fig.cap='Рис. 2. Точечный график зависимости выручки малых предприятий от соотношения заемных и собственных средств с помощью функции stripchart'}
stripchart(Revenue ~ Ratio, data = data, col = '#f3d564', ylab = 'Ratio',
xlab = 'Revenue', main = 'Ratio')
```

На этом графике (рис.2) по оси X откладываются величины выручки, по оси Y категории второго фактора. В результате снизу вверх видим выручку для компаний в зависимости от их соотношения заемных и собственных средств: менее 2, от 2 до 6 и более 6. 

Кроме того, можно изобразить значения средних по периоду реализации (здесь также укажем цвет и подпишем оси). В данном случае период у нас откладывается по оси X, а по оси Y откладываются значения выручки. 

```{r , fig.cap='* Рис. 3. Точечный график зависимости среднего размера выручки от периода реализации продукции (построен с помощью встроенной функции plot)*'}
plot(meanD, type = 'o', col = '#96f364', xlab = 'Date', ylab = 'Revenue')
```

Видим, что объем выручки значительно падает в 3 квартале, но возрастает в 4.

Построим аналогичный график (рис.4) для соотношения заемных и собственных средств.

```{r , fig.cap='* Рис. 4. Точечный график зависимости среднего размера выручки от соотношения заемных и собственных средств (построен с помощью встроенной функции plot)*'}
plot(meanRat, type = 'o', col = '#f3d564', xlab = 'Ratio', ylab = 'Revenue')
```

Согласно графику, наибольшую выручку получают фирмы, у которых соотношение средств более 6.

На этапе предварительного анализа можно построить более информативные графики - например, box plot. Box-and-whisker plot – дословно «ящик с усами» - вид графика, который позволяет увидеть и размах данных, их асимметрию, и наличие выбросов и экстремальных значений в выборке.

```{r , fig.cap='* Рис. 5. Ящичковая диаграмма (box plot) величины выручки малых предприятий в зависимости от периода реализации продукции  (построен с помощью встроенной функции boxplot)*'}
boxplot(Revenue ~ Date, data = data, ylab = 'Revenue', col = '#96f364')
```
На этом графике (рис.5) видим, что, действительно, третий квартал является самым неудачным для предприятий по выручке. В четвертом квартале график совпадает с чертой, обозначающей среднее значение, так как все наблюдения были одинаковы и равны 103.
Построим такой же график для соотношения заемных и собственных средств.

```{r , fig.cap='* Рис. 6. Ящичковая диаграмма (box plot) величины выручки малых предприятий в зависимости от периода реализации продукции  (построен с помощью встроенной функции boxplot)*'}
boxplot(Revenue ~ Ratio, data = data, ylab = 'Revenue', col = '#f3d564')
```

На рисунке 6 замечена та же тенденция, что и на рисунке 4. Наибольшую выручку получают фирмы с соотношением средств больше 6.

Еще одной интересной современной альтернативой графикам типа box-and whisker plot является так называемая скрипичная диаграмма («violin plot»). Этот график является совмещением ящичковой диаграммы и графика плотности вероятности, повернутого набок, то есть еще позволяет увидеть, где с какой плотностью сосредоточены значения случайной величины вместо менее информативного «ящика». Построим скрипичную диаграмму для наших данных. Сначала установим пакет ggplot2, установим категориальный (факторный) тип переменной Date и зададим скрипичный график:

```{r , fig.cap='* Рис. 7. Скрипичная диаграмма (violin plot) объема выручки в зависимости от периода реализации продукции*'}
library('ggplot2')
data$Date <- as.factor(data$Date)
p <- ggplot(data, aes(x = Date, y = Revenue, fill = Date)) + geom_violin(trim = FALSE)
p
```

Для удобства мы можем повернуть скрипичную диаграмму набок - поменять оси местами:

```{r, fig.cap='* Рис. 8. Скрипичная диаграмма (violin plot) объема выручки в зависимости от периода реализации продукции*'}
p + coord_flip()
```

Также в R есть возможность наложить на скрипичную диаграмму ящичковую:

```{r, fig.cap='* Рис. 9. Скрипичная и ящичковая диаграммы объема выручки в зависимости от периода реализации продукции*'}
p + geom_boxplot(width = 0.2)
```

Удобной может оказаться также функция наложения скрипичной диаграммы и диаграммы рассеяния:

```{r, fig.cap='* Рис. 10. Скрипичная диаграмма и диаграмма рассеивания объема выручки в зависимости от периода реализации продукции*'}
p + geom_dotplot(binaxis = 'y', stackdir  = 'center', dotsize = 1)
```

#### 1.1.3. Проведение однофакторного дисперсионного анализа в R

Перейдем непосредственно к дисперсионному анализу. 
Основными предпосылками к применению дисперсионного анализа являются требования, чтобы: 
✓ наблюдения подчинялись нормальному закону,  
✓ дисперсии в группах были примерно равны.  

Перед применением статистических тестов визуально мы также можем проверить, соответствует ли распределение заработной платы нормальному, например, с помощью графика квантиль-квантиль (quantile-quantile plot). В R данный такой график можно построить с помощью пакета car. 

```{r}
library('car')
```

```{r, fig.cap='* Рис. 11. График квантиль-квантиль величины выручки малых фирм и нормального распределения (построен с помощью функции qqPlot пакета car)*'}
qqPlot(data$Revenue)
```

На графике (рис. 11) можем зрительно оценить подгонку теоретического распределения к наблюдаемым значениям. Как видим, сопоставимость достаточно высока, точки наблюдаемых значений сосредоточены вдоль прямой равенства эмпирических и теоретических квантилей. Таким образом, мы можем предположить, что выручка подчиняется нормальному распределению.

Теперь формально проверим, что наша выборка действительно подчиняется нормальному распределению. Переменной, используемой для проведения дисперсионного анализа,  в данном случае  является выручка, именно для нее мы проверим гипотезу о нормальности.  
Для этого существует множество тестов, мы применим критерий Шапиро-Уилка, наиболее подходящий для малых выборок.

```{r}
shapiro.test(data$Revenue)
```
Как мы видим, значение p-value = 0.401 достаточно большое и значительно превышает заданный уровень $a$ = 0.05, значит, нулевая гипотеза о соответствии зависимой переменной нормальному распределению в нашем случае не отвергается, следовательно, мы можем применять дисперсионный анализ. 

Теперь проверим вторую предпосылку применения ДА – однородность дисперсий между уровнями каждого фактора с помощью теста Левене (упомянутого в п. 2.1) – используем функцию leveneTest из пакета car.  Проверим тип наших переменных и получим, что первая переменная – числовая, вторая – текстовая:

```{r}
str(data$Revenue)
str(data$Ratio)
```

В этом случае тест Левене выдаст ошибку – он работает только с факторными признаками. Поэтому перед проведением теста надо снова превратить наши переменные в факторные.

```{r}
data$Ratio <- factor(data$Ratio) 
str(data$Ratio) 
```

Теперь можно провести тест Левене с медианами по умолчанию и средними.

```{r}
leveneTest(data$Revenue, data$Ratio)
leveneTest(data$Revenue, data$Ratio, center = mean)
```

В обоих случаях p-value больше любого разумного уровня значимости, поэтому нулевая гипотеза об однородности дисперсий между группами фактора образования не отвергается. 

И то же самое проводим для второго фактора - периода реализации продукции.

```{r}
leveneTest(data$Revenue, data$Date)
leveneTest(data$Revenue, data$Date, center = mean)
```

Также в обоих случаях p-value больше любого разумного уровня значимости, поэтому нулевая гипотеза об однородности дисперсий между группами фактора стажа также не отвергается.

Итак, все предпосылки применения дисперсионного анализа проверили, можно приступать к самому анализу. Дисперсионный анализ в пакете R реализуем функцией aov() analysis of variance, анализ дисперсии. Для начала мы проверим гипотезу о том, что значения выручки предприятий равны в среднем по всем уровням соотношения средств. Для этого выполним дисперсионный анализ и сразу выведем результаты.То есть, мы в операцию summary() подставляем операцию analysis of variance. В данном случае эта команда выполнит нам однофакторный дисперсионный анализ для стажа работы. То есть на второй фактор в данном случае мы не обращаем внимания, как будто бы его просто нет. Перед нами появляется таблица с основными результатами. Нулевая гипотеза, проверяемая в дисперсионном анализе - что средние всех уровней фактора равны (фактор не влияет на зависимую переменную Y).

```{r}
summary(aov(data$Revenue ~ data$Ratio))
```

В данном случае мы должны посмотреть на значение p-value = 0.504, которое у нас указывается в соответствующей строке, и в данном случае оно больше, чем 0.05 - заданный уровень значимости. Соответственно, с вероятностью ошибки $\alpha = 0,05$ нулевую гипотезу не отвергаем, т.е. на уровне значимости $\alpha = 0,05$ мы можем признать влияние данного фактора статистически не значимым. Можно сделать вывод о том, что соотношение заемных и собственных средств не влияет на объем выручки или по данной выборке влияние фактора не доказано. Проведём аналогичный анализ для периода реализации продукции. Это будет тоже однофакторный дисперсионный анализ без рассмотрения другого фактора.

```{r}
summary(aov(data$Revenue ~ data$Date))
```

В этом случае p-value = 0.00763, что меньше $\alpha = 0,05$. Соответственно, с вероятностью ошибки $\alpha = 0,05$ нулевую гипотезу отвергаем, т.е. на уровне значимости $\alpha = 0,05$ мы можем признать влияние данного фактора статистически значимым. То есть хотя бы между какими-то периодами реализации продукции (фактора) есть разница в средних значениях выручки (𝑌). 

### 1.2. Двухфакторный ДА (Two-Way ANOVA)

#### 1.2.1. Без учета взаимодействия факторов (n=1)

Поскольку в исходной таблице было по одному наблюдению в каждой ячейке,  мы не можем рассматривать эффект взаимодействия факторов. То есть просто добавляем теперь влияние двух факторов в нашу модель.  

```{r}
summary(aov(data$Revenue ~ data$Ratio + data$Date))
```

Здесь дисперсии немного перераспределились, как раз-таки по двум предположительно влияющим факторам. У нас часть дисперсии объясняется фактором соотношения средств, часть дисперсии объясняется влиянием периодом реализации, и также, естественно, присутствует остаточная дисперсия. Сами эти значения у нас указаны во втором столбце, точнее, это не дисперсии, а суммы квадратов.В последнем столбце мы видим значение p-value для проверки гипотез о 
равенстве средних по всем уровням соответствующего фактора. И для соотношения заемных и собственных средств (p-value = 0.0072), и для периода (p-value = 0.0034). Значение для последнего существенно меньше 0.05, соответственно с достаточно высокой статистической значимостью мы отклоняем гипотезы о равенстве средних по обоим факторам и выносим решение об их существенном влиянии на величину выручки предприятий малого бизнеса. 

#### 1.2.2. Проверка равенства средних выбранных уровней (post hoc tests) – тест Тьюки

Проведем тест Тьюки TukeyHSD  (от англ. "honestly significant difference") для сравнения средней выручки предприятий между различными периодами реализации продукции:

```{r}
anova_data <- aov(data$Revenue ~ data$Date)
summary(anova_data)
TukeyHSD(anova_data)
```

Результат проведения теста Тьюки приведён в нижней части кода: в первом столбце содержатся номера сравниваемых групп, во втором — оценка разницы в уровнях, в третьем и четвёртом — нижняя и верхняя границы 95%-го доверительного интервала, а последний столбец содержит в себе p-value. 
Как можно видеть, почти для всех групп доверительный интервал содержит ноль, а p-value значительно превышает 0.05, вследствие чего нулевая гипотеза о равенстве средних не отвергается на заданном уровне значимости. Однако для одной группы (4-3, строка 6) нулевая гипотеза отвергается с вероятностью ошибки $\alpha$ = 0.05, поскольку p-value = 0.0049 < $\alpha$ = 0.05, а соответствующий доверительный интервал не включает в себя ноль.  

Теперь можем визуализировать полученные результаты теста, построив 95-процентные доверительные интервалы для всех уровней образования (рис. 12): 

```{r, fig.cap='* Рис. 12. Доверительные интервалы с надежностью 0,95 для разницы средних выборных периодов реализации*'}
tukey <- TukeyHSD(anova_data)
plot(tukey)
```

Эта визуализация подтверждает полученные выше результаты - как можно видеть, почти для всех групп (кроме последней) доверительный интервал содержит 0, вследствие чего нулевая гипотеза о равенстве средних не отвергается на заданном уровне значимости (левая граница доверительного интервала – отрицательна, правая положительна – т.е. непонятно даже, у какого из уровней фактора больше, а у какого меньше средняя зарплата согласно доверительному интервалу). 
Однако для одной группы (4-3, нижняя) доверительный интервал не включает в себя 0 - поэтому нулевая гипотеза для этой пары средних отвергается с вероятностью ошибки $\alpha$ = 0.05, и различия между этими уровнями фактора образования статистически различаются. Иными словами, объем выручки существенно различается лишь между третьим кварталом (3) и четвертым (4).

#### 1.2.3.  Учет взаимодействия факторов (n>1) 

Допустим, таблица данных имеет по 2 наблюдения в каждой ячейке. Создадим такую таблицу в файле Excel.

```{r}
library(readxl) 
data2 = read_excel('new752.xlsx')
```

Проведя все абсолютно аналогичные действия и тесты для новой таблицы 
данных, мы получим следующие результаты.

```{r}
data2
```

```{r}
meanRat2 = tapply(data2$Revenue2, data2$Ratio2, mean)
meanRat2
```

```{r}
meanD2 = tapply(data2$Revenue2, data2$Date2, mean)
meanD2
```

Можем заметить, что средние в группах отличаются.

```{r}
shapiro.test(data2$Revenue2)
```
p-value = 0.5659 > $\alpha$ = 0.05.

```{r}
data2$Ratio2 <- factor(data2$Ratio2) 
str(data2$Ratio2) 
```
```{r}
data2$Date2 <- factor(data2$Date2) 
str(data2$Date2) 
```

```{r}
leveneTest(data2$Revenue2, data2$Ratio2)
leveneTest(data2$Revenue2, data2$Ratio2, center = mean)
```
```{r}
leveneTest(data2$Revenue2, data2$Date2)
leveneTest(data2$Revenue2, data2$Date2, center = mean)
```

Проверка на нормальное распределение с помощью теста Шапиро-Уилка и на однородность дисперсий между уровнями обоих факторов с помощью теста Левене прошли успешно, предпосылки применения ДА соблюдены, все проверяемые гипотезы не отверглись.

Однофакторный дисперсионный анализ в рамках представленной выборки:

```{r}
summary(aov(data2$Revenue2 ~ data2$Ratio2))
```

p-value = 0.000134

```{r}
summary(aov(data2$Revenue2 ~ data2$Date2))
```
Однофакторный дисперсионный анализ в рамках представленной выборки показал значимое влияние обоих факторов по отдельности. Посмотрим на результаты двухфакторного ДА.

```{r}
summary(aov(data2$Revenue2 ~ data2$Ratio2 + data2$Date2))
```

Двухфакторный дисперсионный анализ без учета взаимодействия факторов в рамках представленной новой выборки также показал значимое влияние обоих факторов на выручку предприятий.

Итак, давайте посмотрим, влияет ли значимо взаимодействие факторов образования и стажа на заработную плату работников.

```{r}
summary(aov(data2$Revenue2 ~ data2$Ratio2 + data2$Date2 + data2$Ratio2 * data2$Date2))
```

Выполнив соответствующую операцию, видим, что p-value для обоих 
факторов меньше уровня значимости $\alpha$ = 0.05. Следовательно, с высокой степенью надёжности влияние и обоих факторов, и эффекта их взаимодействия в данном случае 
доказано. 

Таким образом, при двухфакторном дисперсионном анализе мы получили, что из двух факторов статистически значимо на выручки предприятий в нашем случае влияют оба, то есть и соотношение средств, и период реализации, и их совместное воздействие  также оказывается существенным.